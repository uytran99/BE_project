<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Admin - Heart App</title>
        <style>
            body {
                font-family: Segoe UI, Arial;
                margin: 20px;
            }
            table {
                border-collapse: collapse;
                width: 100%;
                margin-bottom: 20px;
            }
            th,
            td {
                border: 1px solid #ddd;
                padding: 8px;
                text-align: left;
            }
            th {
                background: #f4f4f4;
            }
            button {
                margin-right: 6px;
            }
            .controls {
                margin-bottom: 12px;
            }
        </style>
    </head>
    <body>
        <h1>Admin Panel</h1>
        <div class="controls">
            <label>Admin token: <input id="token" placeholder="paste token" style="width: 320px" /></label>
            <button id="refresh">Refresh</button>
            <button id="export">Export CSV</button>
        </div>

        <h2>Users</h2>
        <div id="users"></div>

        <h2>Data Records</h2>
        <div id="data"></div>

        <script>
            const tokenInput = document.getElementById("token");
            const headers = () => ({ "x-admin-token": tokenInput.value });

            async function fetchJson(url, opts = {}) {
                opts.headers = Object.assign({}, opts.headers || {}, headers());
                const r = await fetch(url, opts);
                return r.json();
            }

            function el(tag, txt) {
                const e = document.createElement(tag);
                if (txt !== undefined) e.textContent = txt;
                return e;
            }

            async function renderUsers() {
                const res = await fetchJson("/admin/api/users");
                const container = document.getElementById("users");
                container.innerHTML = "";
                if (!res.success) return (container.textContent = "Error: " + (res.error || JSON.stringify(res)));
                const table = document.createElement("table");
                const thead = el("thead");
                thead.innerHTML = "<tr><th>ID</th><th>Username</th><th>Email</th><th>Age</th><th>Actions</th></tr>";
                table.appendChild(thead);
                const tbody = document.createElement("tbody");
                res.users.forEach((u) => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `<td>${u._id}</td><td>${u.username || ""}</td><td>${u.email || ""}</td><td>${u.age || ""}</td>`;
                    const td = document.createElement("td");
                    const btnDelete = document.createElement("button");
                    btnDelete.textContent = "Delete";
                    btnDelete.onclick = async () => {
                        if (confirm("Delete user?")) {
                            await fetchJson("/admin/api/users/" + u._id, { method: "DELETE" });
                            await refreshAll();
                        }
                    };
                    td.appendChild(btnDelete);
                    tr.appendChild(td);
                    tbody.appendChild(tr);
                });
                table.appendChild(tbody);
                container.appendChild(table);
            }

            async function renderData() {
                const res = await fetchJson("/admin/api/data");
                const container = document.getElementById("data");
                container.innerHTML = "";
                if (!res.success) return (container.textContent = "Error: " + (res.error || JSON.stringify(res)));
                const table = document.createElement("table");
                const thead = el("thead");
                thead.innerHTML = "<tr><th>ID</th><th>UserId</th><th>HR</th><th>Status</th><th>AI</th><th>Time</th><th>Actions</th></tr>";
                table.appendChild(thead);
                const tbody = document.createElement("tbody");
                res.records.forEach((r) => {
                    const tr = document.createElement("tr");
                    const ai = r.aiDiagnosis ? r.aiDiagnosis.diagnosis || r.aiDiagnosis.severity : "";
                    tr.innerHTML = `<td>${r._id}</td><td>${r.userId || ""}</td><td>${r.heartRate || ""}</td><td>${r.status || ""}</td><td>${ai}</td><td>${new Date(r.createdAt).toLocaleString()}</td>`;
                    const td = document.createElement("td");
                    const btnDelete = document.createElement("button");
                    btnDelete.textContent = "Delete";
                    btnDelete.onclick = async () => {
                        if (confirm("Delete record?")) {
                            await fetchJson("/admin/api/data/" + r._id, { method: "DELETE" });
                            await refreshAll();
                        }
                    };
                    const btnRe = document.createElement("button");
                    btnRe.textContent = "Re-diagnose";
                    btnRe.onclick = async () => {
                        btnRe.textContent = "Working...";
                        await fetchJson("/admin/api/re-diagnose/" + r._id, { method: "POST" });
                        btnRe.textContent = "Re-diagnose";
                        await refreshAll();
                    };
                    td.appendChild(btnRe);
                    td.appendChild(btnDelete);
                    tr.appendChild(td);
                    tbody.appendChild(tr);
                });
                table.appendChild(tbody);
                container.appendChild(table);
            }

            async function exportCSV() {
                const token = tokenInput.value;
                if (!token) {
                    alert("Provide admin token");
                    return;
                }
                const url = "/admin/api/export/data";
                // force download by navigating with token as query param (middleware accepts query)
                window.location = url + "?adminToken=" + encodeURIComponent(token);
            }

            async function refreshAll() {
                await renderUsers();
                await renderData();
            }

            document.getElementById("refresh").addEventListener("click", refreshAll);
            document.getElementById("export").addEventListener("click", exportCSV);

            // initial (user must paste token)
            document.getElementById("token").addEventListener("keyup", (e) => {
                if (e.key === "Enter") refreshAll();
            });
        </script>
    </body>
</html>
